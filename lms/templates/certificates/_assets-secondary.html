<!-- html2canvas dla konwersji certyfikatu do obrazka -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- jsPDF dla zapisu do PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="text/javascript">

    document.getElementById("action-print-view").addEventListener("click", printView);

    function printView(event) {
       event.preventDefault();
       
       // Znajdź przycisk
       var printBtn = document.getElementById("action-print-view");
       var originalHTML = printBtn.innerHTML;
       
       // Pokaż komunikat ładowania
       printBtn.disabled = true;
       printBtn.innerHTML = '<span class="icon fa fa-spinner fa-spin" aria-hidden="true"></span> Generowanie PDF...';
       
       // Znajdź certyfikat
       var certificate = document.querySelector('.certificate-page');
       
       if (!certificate) {
           console.error('Nie znaleziono certyfikatu');
           window.print();
           printBtn.disabled = false;
           printBtn.innerHTML = originalHTML;
           return;
       }
       
       // Konwertuj na obraz z szerokością > 800px żeby uniknąć responsive breakpoint
       html2canvas(certificate, {
           scale: 2,
           useCORS: true,
           allowTaint: false,
           backgroundColor: '#ffffff',
           width: Math.max(certificate.offsetWidth, 850),
           height: certificate.offsetHeight,
           windowWidth: Math.max(certificate.scrollWidth, 850),
           windowHeight: certificate.scrollHeight
       }).then(function(canvas) {
           // Utwórz PDF z canvas
           var imgData = canvas.toDataURL('image/png');
           var imgWidth = canvas.width;
           var imgHeight = canvas.height;
           
           // A4 w mm
           var pdfWidth = 210;
           var pdfHeight = 297;
           
           // Oblicz proporcje
           var ratio = Math.min(pdfWidth / (imgWidth * 0.264583), pdfHeight / (imgHeight * 0.264583));
           var scaledWidth = (imgWidth * 0.264583) * ratio;
           var scaledHeight = (imgHeight * 0.264583) * ratio;
           
           // Wyśrodkuj na stronie
           var xOffset = (pdfWidth - scaledWidth) / 2;
           var yOffset = (pdfHeight - scaledHeight) / 2;
           
           // Utwórz PDF
           const { jsPDF } = window.jspdf;
           var pdf = new jsPDF({
               orientation: 'portrait',
               unit: 'mm',
               format: 'a4'
           });
           
           pdf.addImage(imgData, 'PNG', xOffset, yOffset, scaledWidth, scaledHeight);
           
           // Zapisz PDF
           var fileName = 'certyfikat_' + new Date().getTime() + '.pdf';
           pdf.save(fileName);
           
           // Przywróć przycisk
           printBtn.disabled = false;
           printBtn.innerHTML = originalHTML;
           
       }).catch(function(error) {
           console.error('Błąd konwersji do obrazka:', error);
           // Fallback do standardowego drukowania
           alert('Wystąpił błąd przy przygotowaniu certyfikatu. Użyj standardowego drukowania przeglądarki.');
           printBtn.disabled = false;
           printBtn.innerHTML = originalHTML;
       });
    }
</script>
